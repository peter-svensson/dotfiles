# use_fnm: fnm (Fast Node Manager) integration for direnv
# Modern setup using fnm instead of legacy nvm
#
# Usage in .envrc:
# 1) Node version from package.json:
#      use fnm package.json
#    Requires package.json with:
#      "engines": { "node": ">=18.0.0" }
#
# 2) Explicit Node version:
#      use fnm 20
#      use fnm 18.20.0
#
# 3) From .nvmrc (if present):
#      use fnm
#
# Note: fnm with --use-on-cd will automatically handle .nvmrc files
# without direnv, but this function is useful for package.json integration.
use_fnm() {
  local node_version=$1

  # If argument is package.json, extract version
  if [[ $node_version = "package.json" ]]; then
    if has jq; then
      # Extract version and clean it (remove <, >, =, ~, ^, spaces)
      node_version=$(jq --raw-output '.engines.node | select (.!=null)' package.json | tr -d '<=>~^ ' | cut -d. -f1)
    else
      log_error "Parsing package.json for Node version requires jq"
      return 1
    fi
    if [[ -z $node_version ]]; then
      log_error "No version found in package.json engines.node field"
      return 1
    fi
    log_status "Using Node version $node_version from package.json"
  fi

  # If no argument and .nvmrc exists, read from it
  if [[ -z $node_version ]] && [[ -f .nvmrc ]]; then
    node_version=$(cat .nvmrc)
    log_status "Using Node version from .nvmrc: $node_version"
  fi

  # Check if fnm is available
  if ! has fnm; then
    log_error "fnm not found. Install it with: brew install fnm"
    return 1
  fi

  # Ensure fnm is initialized
  eval "$(fnm env --use-on-cd)"

  # Install version if not already installed
  if ! fnm list | grep -q "v$node_version"; then
    log_status "Installing Node $node_version with fnm..."
    fnm install "$node_version"
  fi

  # Use the specified version
  fnm use "$node_version"

  # Add node binaries to PATH
  PATH_add "$(fnm current | xargs -I {} echo "$FNM_MULTISHELL_PATH/{}/bin")"
}

# use_nvm: Backward compatibility alias for use_fnm
# Redirects all use_nvm calls to use_fnm for seamless migration
# Usage: Same as use_fnm - use_nvm package.json, use_nvm 20, use_nvm
use_nvm() {
  log_status "Note: use_nvm is deprecated, redirecting to use_fnm"
  use_fnm "$@"
}
